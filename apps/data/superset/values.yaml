# External DB (PostgreSQL) + OIDC Auth

ingress:
  enabled: true
  ingressClassName: traefik
  hosts:
    - superset.valab.top
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    gethomepage.dev/enabled: "true"
    gethomepage.dev/description: "Data Visualization"
    gethomepage.dev/group: "Data"
    gethomepage.dev/icon: "si-apachesuperset"
    gethomepage.dev/name: "Superset"
    gethomepage.dev/href: "https://superset.valab.top"
    traefik.ingress.kubernetes.io/router.middlewares: security-tinyauth-protect@kubernetescrd
  tls:
    - hosts:
        - superset.valab.top
      secretName: superset-tls

# Database (External PostgreSQL via Ansible)
postgresql:
  enabled: false # External DB is used, but if needed for internal, set storageClass here
  primary:
    persistence:
      storageClass: "nfs-csi-nvme"

supersetNode:
  connections:
    db_host: "pg-db" # Matches Immich DB Host (LXC container)
    db_port: 5432
    db_user: superset
    db_pass: "$DB_PASS"
    db_name: superset_db
    redis_host: superset-redis-master
    redis_port: 6379

# Caching (Redis) - Keep internal or move external too? Keep internal for now.
redis:
  enabled: true
  image:
    registry: public.ecr.aws
    repository: bitnami/redis
    tag: 7.2.4-debian-12-r9
  auth:
    enabled: false
  architecture: standalone
  master:
    persistence:
      enabled: true
      storageClass: "nfs-csi-nvme"
  volumePermissions:
    enabled: true
    image:
      registry: public.ecr.aws
      repository: bitnami/bitnami-shell
      tag: 11-debian-11-r102

configOverrides:
  secret: |
    import os
    SECRET_KEY = os.environ.get('SUPERSET_SECRET_KEY')
    ENABLE_PROXY_FIX = True
    PREFERRED_DATABASES = ['ClickHouse', 'PostgreSQL', 'MySQL']
  
  oidc: |
    import os
    from flask_appbuilder.security.manager import AUTH_OAUTH
    AUTH_TYPE = AUTH_OAUTH
    OAUTH_PROVIDERS = [
        {
            "name": "pocketid",
            "icon": "fa-address-card",
            "token_key": "access_token",
            "remote_app": {
                "client_id": os.environ.get('POCKETID_CLIENT_ID'),
                "client_secret": os.environ.get('POCKETID_CLIENT_SECRET'),
                "server_metadata_url": "https://auth-id.valab.top/.well-known/openid-configuration",
                "client_kwargs": {"scope": "openid profile email"},
            }
        }
    ]
    # Auto-registration
    AUTH_USER_REGISTRATION = True
    AUTH_USER_REGISTRATION_ROLE = "Admin"

bootstrapScript: |
  #!/bin/bash
  pip install clickhouse-connect Authlib
  if [ ! -f ~/bootstrap ]; then echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap; fi

extraEnvRaw:
  - name: DB_PASS
    valueFrom:
      secretKeyRef:
        name: superset-pg-secret
        key: password
  - name: SUPERSET_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: SECRET_KEY
  - name: POCKETID_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: POCKETID_CLIENT_ID
  - name: POCKETID_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: POCKETID_CLIENT_SECRET
