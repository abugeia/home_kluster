# ==========================================================
# 1. IMAGE & VERSION
# ==========================================================
image:
  tag: 6.0.0
  pullPolicy: IfNotPresent

# ==========================================================
# 2. INGRESS & RESEAU
# ==========================================================
ingress:
  enabled: true
  ingressClassName: traefik
  hosts:
    - superset.valab.top
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    gethomepage.dev/enabled: "true"
    gethomepage.dev/description: "Data Visualization"
    gethomepage.dev/group: "Data"
    gethomepage.dev/icon: "si-apachesuperset"
    gethomepage.dev/name: "Superset"
    gethomepage.dev/href: "https://superset.valab.top"
    # ⚠️ RETIRÉ : TinyAuth entrerait en conflit avec l'OIDC interne de Superset
    # traefik.ingress.kubernetes.io/router.middlewares: security-tinyauth-protect@kubernetescrd
  tls:
    - hosts:
        - superset.valab.top
      secretName: superset-tls

# ==========================================================
# 3. BASE DE DONNÉES (EXTERNE)
# ==========================================================
postgresql:
  enabled: false # On désactive car tu as ta propre DB

# ==========================================================
# 4. REDIS (CACHE + CELERY BROKER)
# ==========================================================
redis:
  enabled: true
  # ✅ Validé : Utiliser ECR est recommandé pour éviter les rate-limits Docker Hub
  image:
    registry: public.ecr.aws
    repository: bitnami/redis
    tag: 7.2.4-debian-12-r9
  auth:
    enabled: false # OK pour un homelab interne
  architecture: standalone
  master:
    persistence:
      enabled: true
      storageClass: "nfs-csi-nvme"
      size: 8Gi

# ==========================================================
# 5. WORKERS (OBLIGATOIRE POUR CLICKHOUSE/ASYNC)
# ==========================================================
# Le "beat" lance les tâches planifiées (alertes, emails, cleanup)
supersetCeleryBeat:
  enabled: true

# Le "worker" exécute les requêtes SQL lourdes en arrière-plan
supersetWorker:
  enabled: true
  replicaCount: 1
  command:
    - "/bin/sh"
    - "-c"
    - ". /app/pythonpath/superset_config.py && celery --app=superset.tasks.celery_app:app worker -O fair -l INFO"

# ==========================================================
# 6. CONFIGURATION PYTHON & DRIVERS
# ==========================================================
configOverrides:
  secret: |
    import os
    SECRET_KEY = os.environ.get('SUPERSET_SECRET_KEY')
    
  # Configuration DB Externe & Celery
  database: |
    import os
    # Construction de l'URI Postgres avec le mot de passe injecté
    SQLALCHEMY_DATABASE_URI = f"postgresql://superset:{os.environ.get('DB_PASS')}@pg-db:5432/superset_db"
    
    # Configuration Celery (Redis interne via le nom du service K8s)
    class CeleryConfig(object):
        BROKER_URL = 'redis://superset-redis-master:6379/0'
        CELERY_IMPORTS = ('superset.sql_lab', 'superset.tasks',)
        CELERY_RESULT_BACKEND = 'redis://superset-redis-master:6379/1'
    CELERY_CONFIG = CeleryConfig

    # Cache Configuration (Indispensable pour la rapidité)
    CACHE_CONFIG = {
        'CACHE_TYPE': 'RedisCache',
        'CACHE_DEFAULT_TIMEOUT': 86400,
        'CACHE_KEY_PREFIX': 'superset_results',
        'CACHE_REDIS_URL': 'redis://superset-redis-master:6379/2',
    }
    DATA_CACHE_CONFIG = CACHE_CONFIG

  # Feature Flags & Réseau
  network: |
    ENABLE_PROXY_FIX = True
    TALISMAN_ENABLED = False # Superset pense être en HTTP (derrière Traefik), donc on désactive le force-HTTPS interne
    
    # Permet d'upload des CSV/Excel pour croiser avec tes données ClickHouse
    CSV_EXTENSIONS = {"csv", "tsv", "txt"}
    EXCEL_EXTENSIONS = {"xls", "xlsx"}
    ALLOWED_EXTENSIONS = set(CSV_EXTENSIONS.union(EXCEL_EXTENSIONS))

  # Configuration OIDC (PocketID)
  oidc: |
    import os
    from flask_appbuilder.security.manager import AUTH_OAUTH
    AUTH_TYPE = AUTH_OAUTH
    
    # "Admin" est OK si tu es le seul utilisateur du Homelab.
    # Sinon change pour "Gamma" (Lecture seule par défaut)
    AUTH_USER_REGISTRATION = True
    AUTH_USER_REGISTRATION_ROLE = "Admin" 

    OAUTH_PROVIDERS = [
        {
            "name": "pocketid",
            "icon": "fa-address-card",
            "token_key": "access_token",
            "remote_app": {
                "client_id": os.environ.get('POCKETID_CLIENT_ID'),
                "client_secret": os.environ.get('POCKETID_CLIENT_SECRET'),
                "server_metadata_url": "https://auth-id.valab.top/.well-known/openid-configuration",
                "client_kwargs": {"scope": "openid profile email"},
            }
        }
    ]

# Script de démarrage : Installation des drivers
bootstrapScript: |
  #!/bin/bash
  # ⚠️ Ajout de --user car le conteneur tourne en 'superset' (non-root)
  # clickhouse-connect est le driver moderne recommandé
  pip install --user --no-cache-dir clickhouse-connect Authlib
  
  if [ ! -f ~/bootstrap ]; then echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap; fi

extraEnvRaw:
  - name: DB_HOST
    value: "10.0.0.12"
  - name: DB_PORT
    value: "5432"
  - name: DB_USER
    value: "superset"
  - name: DB_PASS
    valueFrom:
      secretKeyRef:
        name: superset-pg-secret
        key: password
  - name: SUPERSET_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: SECRET_KEY
  - name: POCKETID_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: POCKETID_CLIENT_ID
  - name: POCKETID_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: superset-secrets
        key: POCKETID_CLIENT_SECRET