# Bitnami ClickHouse Values
# Optimized for "Home Lab" with NVMe Storage and ClickHouse Keeper

global:
  storageClass: "nfs-csi-nvme" # Using the NVMe StorageClass

auth:
  username: admin
  # password comes from secret 'clickhouse-credentials' (managed by ExternalSecret or sealed-secret)
  existingSecret: "clickhouse-credentials"

# Architecture: Use ClickHouse Keeper (Embedded) instead of ZooKeeper
zookeeper:
  enabled: false

clickhouse:
  keeper:
    enabled: true
    persistence:
      enabled: true
      size: 1Gi # Keeper logs are small

# Init Scripts: To create Users and Databases automatically
initdbScripts:
  create_users.sql: |
    -- User for Superset (Read-Only on data, mostly)
    CREATE USER IF NOT EXISTS superset IDENTIFIED WITH sha256_password BY 'superset'; 
    GRANT SELECT ON *.* TO superset;
    
    -- User for Data Loader (Write access)
    CREATE USER IF NOT EXISTS loader IDENTIFIED WITH sha256_password BY 'loader';
    GRANT ALL ON *.* TO loader;
    
    -- Ensure Database exists (if not default)
    CREATE DATABASE IF NOT EXISTS raw_data;

# Server Resources: Tuned for Low RAM usage
resources: 
  limits:
    memory: 2Gi # Allow peaking
  requests:
    memory: 512Mi # Low baseline request

persistence:
  enabled: true
  size: 20Gi # Adjust based on data volume need

# Custom Configuration to limit RAM & Cache
configuration: |
  <!-- Tuned for Low Memory & Aggressive Cleanup -->
  <clickhouse>
      <max_server_memory_usage_to_ram_ratio>0.7</max_server_memory_usage_to_ram_ratio>
      <max_memory_usage>1610612736</max_memory_usage> <!-- 1.5GB limit before spilling to disk -->
      
      <!-- Reduce cache sizes significantly to free up RAM when idle -->
      <mark_cache_size>53687091</mark_cache_size> <!-- 50MB (was 100MB) -->
      <uncompressed_cache_size>53687091</uncompressed_cache_size> <!-- 50MB (New: limit uncompressed cache) -->
      <compiled_expression_cache_size>10485760</compiled_expression_cache_size> <!-- 10MB -->
      
      <logger>
          <level>warning</level>
      </logger>
  </clickhouse>

# Ingress: Enabled for convenience (DataGrip/DBeaver)
ingress:
  enabled: true
  ingressClassName: traefik
  hostname: clickhouse.valab.top
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: security-tinyauth-protect@kubernetescrd

service:
  type: ClusterIP
  ports:
    http: 8123
    tcp: 9000
