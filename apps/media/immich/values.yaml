# Immich Helm Values pour Home Kluster
# Chart: immich/immich (https://immich-app.github.io/immich-charts)
# Note: L'image tag suit la version du chart par défaut

# Configuration principale
controllers:
  main:
    containers:
      main:
        image:
          tag: v2.4.1
        env:
          REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
          IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
          # PostgreSQL externe
          DB_HOSTNAME: "10.0.0.12"
          DB_PORT: "5432"
          DB_DATABASE_NAME: "immich_db"
          DB_USERNAME: "immich"
          # Le mot de passe sera passé via un secret
          DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: immich-pg-secret  # Créé par Ansible via postgresql_databases
                key: password

immich:
  persistence:
    library:
      existingClaim: immich-library
    import:
      enabled: true
      type: persistentVolumeClaim
      existingClaim: immich-import
      mountPath: /mnt/import
      readOnly: true
  # Configuration OIDC PocketID
  configuration:
    # oauth:
      # NOTE: Configuration OAuth désactivée en mode déclaratif pour deux raisons :
      # 1. Gestion des Secrets : Immich ne supporte pas de lire le ClientSecret via une variable d'environnement ou Secret K8s.
      #    Il faudrait le mettre en clair ici, ce qui n'est pas sécurisé dans Git.
      # 2. Validation Stricte : Le validateur du chart rejette certaines URIs custom (mobileRedirectUri) nécessaires.
      #
      # -> La configuration doit être faite via l'interface web (Administration -> Settings -> OAuth Authentication)
      #    Cela stockera la config en base de données de manière persistante.
      #
      # enabled: false
      # issuerUrl: "https://auth-id.valab.top"
      # autoRegister: true
      # autoLaunch: false
      # buttonText: "Se connecter avec PocketID"
      # mobileOverrideEnabled: true
      # mobileRedirectUri: "app.immich:///oauth-callback"

# Désactiver PostgreSQL interne (supprimé dans v0.10.3+)
# La configuration externe est gérée via les variables d'environnement DB_*

# Valkey (Redis) - activé pour la gestion des jobs
valkey:
  enabled: true
  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      size: 1Gi
      storageClass: nfs-csi-nvme
      accessMode: ReadWriteOnce

# Server
server:
  enabled: true
  controllers:
    main:
      containers:
        main:
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
  ingress:
    main:
      enabled: true
      ingressClassName: traefik
      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/description: "Photo Management"
        gethomepage.dev/group: "Media"
        gethomepage.dev/icon: "immich.png"
        gethomepage.dev/name: "Immich"
        # gethomepage.dev/widget.type: "immich" # Requires API key
        cert-manager.io/cluster-issuer: letsencrypt
      tls:
        - hosts:
            - immich.valab.top
            - photos.valab.top
          secretName: immich-tls
      hosts:
        - host: immich.valab.top
          paths:
            - path: "/"
              service:
                identifier: main
        - host: photos.valab.top
          paths:
            - path: "/"
              service:
                identifier: main

# Machine Learning
machine-learning:
  enabled: true
  controllers:
    main:
      containers:
        main:
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
  persistence:
    cache:
      enabled: true
      type: persistentVolumeClaim
      size: 10Gi
      storageClass: nfs-csi-nvme
      accessMode: ReadWriteOnce
