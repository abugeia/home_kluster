# ==========================================================
# AUTH STACK (PocketID + TinyAuth)
# Optimized for bjw-s/app-template v3
# ==========================================================
app-template:
  controllers:
    # 1. POCKET ID (L'Annuaire)
    pocketid:
      containers:
        app:
          image:
            repository: ghcr.io/pocket-id/pocket-id
            tag: latest
          env:
            PUBLIC_APP_URL: "https://auth-id.valab.top"

    # 2. TINYAUTH (Le Portail Unique)
    tinyauth:
      containers:
        app:
          image:
            repository: ghcr.io/steveiliop56/tinyauth
            tag: latest
          env:
            APP_URL: "https://auth.valab.top"
            PROVIDERS_GOOGLE_TYPE: "google"
            PROVIDERS_GOOGLE_NAME: "Google"
            PROVIDERS_GOOGLE_CLIENT_ID:
              valueFrom:
                secretKeyRef:
                  name: auth-secrets
                  key: google-client-id
            PROVIDERS_GOOGLE_CLIENT_SECRET:
              valueFrom:
                secretKeyRef:
                  name: auth-secrets
                  key: google-client-secret
            PROVIDERS_POCKET_TYPE: "oidc"
            PROVIDERS_POCKET_NAME: "Passkey"
            PROVIDERS_POCKET_ISSUER_URL: "https://auth-id.valab.top"
            PROVIDERS_POCKET_SCOPES: "openid profile email"
            PROVIDERS_POCKET_CLIENT_ID:
              valueFrom:
                secretKeyRef:
                  name: auth-secrets
                  key: pocket-client-id
            PROVIDERS_POCKET_CLIENT_SECRET:
              valueFrom:
                secretKeyRef:
                  name: auth-secrets
                  key: pocket-client-secret
            SECRET:
              valueFrom:
                secretKeyRef:
                  name: auth-secrets
                  key: tinyauth-secret
            OAUTH_WHITELIST: "abugeia@gmail.com,admin@pocketid"

  service:
    pocketid:
      controller: pocketid
      ports:
        http:
          port: 80
    tinyauth:
      controller: tinyauth
      ports:
        http:
          port: 3000

  ingress:
    pocketid:
      enabled: true
      className: traefik
      hosts:
        - host: auth-id.valab.top
          paths:
            - path: /
              service:
                identifier: pocketid
                port: 80
    tinyauth:
      enabled: true
      className: traefik
      hosts:
        - host: auth.valab.top
          paths:
            - path: /
              service:
                identifier: tinyauth
                port: 3000